---
title: "Managing sleep records with rsleep"
output: rmarkdown::html_vignette
bibliography: Managing_Sleep_Records_With_rsleep.bibtex
csl: vignettes.csl
vignette: >
  %\VignetteIndexEntry{Managing_Sleep_Records_With_rsleep}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Records of physiological signals during sleep can take many forms. It starts with simple accelerometry @vanheesEstimatingSleepParameters2018 and goes up to full polysomnography (PSG) @AASMScoringManual, a simultaneous recording of more than ten physiological signals. But sleep records all share a common aspect: they are timeseries, collections of datapoints indexed in time order, along their metadata: recording conditions, patient information...

The European Data Format (EDF) has been firstly described in 1992 to ease medical timeseries exchange between research teams @Kemp1992. Primarily conceived to store polygraphic signals, the design has been updated in 2003 to support events data in files, thus renaming the format to EDF+ @Kemp2003. Another update in 2013 now allow video data storage @Kemp2013. A small website recaps history and lists a few data, software and users of the format: [http://edfplus.info/](http://edfplus.info/).

Since its publication, the EDF imposed itself as a standard for exchange of sleep records. Files size come from few hundred megabytes to a few gigabytes, accoring to the variety of signals and their resolution. Many libraries to read EDF files are available for progamming languages, including R.

## EDF files

An example EDF file can be donwloaded using the following code:

```{r download_edf_hidden, include=FALSE}
if(!file.exists("15012016HD.edf")){
  download.file("http://cloud.frenchkpi.com/s/65cm6DMq7SYKQ6J/download", "15012016HD.edf")
}
```

```{r download_data_display, eval=FALSE}
download.file("http://cloud.frenchkpi.com/s/65cm6DMq7SYKQ6J/download", "15012016HD.edf")
```

To read EDF files, we can use the R library [`edfReader`](https://cran.r-project.org/web/packages/edfReader/index.html). Reading an EDF file takes two steps: First reading the headers, then reading the signals.

```{r read_edf}
library(edfReader)

h <- readEdfHeader("15012016HD.edf")

s <- readEdfSignals(h, signals = c("C3-M2", "ECG"))
```

The variable `s` now contains signals in a convenient list. For instance, the electroencephalographic derivation `C3-M2` signal and sample rate can be accessed like this:

```{r}
c3m2 <- s$`C3-M2`$signal

c3m2sr <- s$`C3-M2`$sRate
```

Plotting seconds 30 to 60 of the record looks like this:

```{r fig.width = 7}
plot(c3m2[(c3m2sr*30):(c3m2sr*30*2)],type = "l")
```

# Morpheo Data Format

Although EDF imposed itself as a standard for data exchange, it may not be seen as suitable for all of the usages. While the standard supports events since 2003, very few software allow events exportation directly in EDF files. When finding new ways to store physiological data, one must keep in mind some simple rule to ensure its effectiveness:

  * **Simplicity**: Data format definitions must be straightforward, understadable by non-IT population to lower technical barriers in using the format.
  
  * **Interoperability**: Data must be able to be read and wrote easily on every platform, using any programming language. This implies format definitions must be published and open sourced while respecting several standards.
  
  * **Efficiency**: A good data format must not slow down operations with costly read and write operations.
  
  * **Scalability**: Usages of today are not the usages of tomorrow. 20 years ago, it was not common to compare thousands of PSGs in a single analysis. But big data democratization lowered costs and made it possible. Who knows the data usages in 20 years?

Following these recommendations, a consortium of a few public and private laboratories published in 2018 the implementation a new format: the Morpheo Data Format (MDF) @bouchequetMorpheoDataFormat2018. The MDF format does no aim to replace EDF as a standard for data exchange. It a format designed to ease simultaneous work and collaboration over records stored on disk while ensuring interoperability,

This format firstly distinguishes signal data from events and metadata. Signals regroup all the physiological, high sample rate timeseries such as electroencephalography, electrocardiography, nasal flow, oxygen levels, and so on. Metadata, as its name suggests, is data about the record. Patient identifier, recording conditions and all fields describing the record are considered metadata. Events include sleep scoring and technical events such as equipment logs.

In MDF, signals are stored as raw binary files, while events are stored in a plain-text, human-readable format.

## Events

```{r download_events, eval=FALSE}
download.file("http://cloud.frenchkpi.com/s/wreGqkitWNnWwnP/download", "15012016HD.csv")
```



## Writing EDF files

## Reading EDF files

# References

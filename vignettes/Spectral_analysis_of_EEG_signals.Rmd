---
title: "Spectral analysis of electroencephalography (EEG) signals in sleep data"
output: rmarkdown::html_vignette
bibliography: Spectral_analysis_of_EEG_signals.bibtex
csl: vignettes.csl
vignette: >
  %\VignetteIndexEntry{Spectral_analysis_of_EEG_signals}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

knitr::opts_chunk$set(eval = all(file.exists("15012016HD.edf","15012016HD.csv")))
```

Electroencephalography (EEG) refers to all the methods of recording, analysis and interpretation of the electrical activity of the brain. In clinical EEG, multiple electrodes are usually placed on the scalp, measuring this electival activity over a period of time. Those electrodes are typically arranged on the scalp using a standardized method: the 10-20 system @niedermeyerElectroencephalographyBasicPrinciples2005. 

EEG is a major component in sleep analysis. Sleep stages are mainly defined over EEG characteristics @AASMScoringManual. And many sleep related disorders modify EEG data. Polysomnography, the gold standard exam in sleep medicine, includes EEG @ibanezSurveySleepAssessment2018. 

EEG data can be found in sleep records files. In European Data Format (EDF) @Kemp1992 files, EEG channels can be found under their placement names. The following vignette explains how to extract this data and perform basic spectral analysis over EEG data.

## Example data

An example EDF file and its visual scoring can be donwloaded using the following code:

```{r download_data, eval=FALSE}
download.file("https://osf.io/57j2u/download", "15012016HD.edf")
download.file("https://osf.io/h4ysj/download", "15012016HD.csv")
```

This night has been recorded on healthy subject at the Sleep and Vigilance center of the HÃ´tel-Dieu, Paris, France. To read EDF files, we can use the R library [`edfReader`](https://cran.r-project.org/web/packages/edfReader/index.html). Reading an EDF file takes two steps: First reading the headers, then reading the signals. Signals can be filtered to read only the needed ones. In our case, we only need one EEG channel to perform the analysis. 

```{r read_edf}
library(edfReader)

h <- readEdfHeader("15012016HD.edf")

s <- readEdfSignals(h, signals = "C3-M2")
```

Visual scoring of this record gives the following hypnogram:

```{r hypnogram, fig.width = 7}
library(rsleep)

events <- read_events_noxturnal("15012016HD.csv")

plot_hypnogram(events)
```

The hypnogram show sleep stages over time using consecutive 30 seconds epochs. A sleep expert scored this record visually following the guidelines from the American Association of Sleep Medicine (AASM) @AASMScoringManual. Five stages can be observed:

  * **AWA**: Awakeness.
  * **REM**: Rapid-Eye-Movement (REM) sleep, or paradoxical sleep.
  * **N1**: Light sleep, a transitional stage.
  * **N2,N3**: Slow-wave sleep.

## Spectrogram

The Fourier transform (FT) may be the most important function in signal analysis. It decomposes the signal into its constituent frequencies. A nice interactive and visual explanation of Fourier transform can be found on [\@jezzamon](https://twitter.com/jezzamonn) website: [http://www.jezzamon.com/fourier/](http://www.jezzamon.com/fourier/).

Applied to EEG, Fourier transform gives an overview of the frequencies making the brain activity. 
A **spectrogram** is the visualisation of these frequencies over time. It chops the signal into overlapping slices, windows each slice and applies a Fourier transform to determine the frequency components at that slice. The `spectrogram` function from the `rsleep` package draw a spectrogram from a given signal. This function is a wrapper over the `specgram` function from the `signal` package, adapted to large signals vectors found in sleep data, defining peasant colors and limiting the frequencies displayed to 25 Hertz. Those parameters can be modified in the function call.

```{r spectrogram, fig.width = 7}
spectrogram(signal = s$signal,
            sRate = s$sRate,
            startTime = as.POSIXct(s$startTime))
```

This heatmap show an estimate of power spectral density (PSD) by frequency over time. Cycles of higher PSD in the lower part of the spectrum occurs all along the night. Similar Patterns can be identified between the hypnogram and the spectrogram. Indeed, higher PSD in lower frequencies of the EEG is the main characteristic of deep sleep.

## Spectrum bands

The traditional way to analyze EEG is to cut the frequencies of the spectrum into bands. Bands limits can slightly vary between publications, but these four are the most found and used:

  * **Delta**: Between `0.5` and `3.5` Hertz, the Delta band is associated with slow-wave sleep in adults subjects.
  
  * **Theta**: Between `3.5` and `7.5` Hertz, the Theta band is associated with drowsiness in adults and teens subjects.
  
  * **Alpha**: Between `7.5` and `13` Hertz, the Alpha band is associated with a relaxed state and eyes closed.
  
  * **Beta**: Between `13` and `30` Hertz the Beta band is associated with active thinking, focus, high alert or anxiousness.

### Epoching

To observe spectral powers of bands per sleep stages, 

```{r epochs}
hypnogram <- hypnogram(events)

epochs <- epochs(signals = s$signal,
                 sRates = s$sRate,
                 epoch = hypnogram,
                 startTime = as.numeric(as.POSIXct(s$startTime)))
```

```{r}
bands <- lapply(epochs,function(x){
    bands_power(bands = list(c(0.5,3.5),c(3.5,7.5),c(7.5,13),c(13,30)),
                signal = x, sRate = 200,
                normalize = c(0.5,30))
})
```


## Periodogram

```{r periodogram, fig.width=7, message=FALSE, error=FALSE}
library(dplyr)
library(ggplot2)

periodograms <- mapply(x = epochs, y = hypnogram$event[-1], FUN = function(x,y){
  periodogram <- phonTools::pwelch(x, fs = s$sRate, show = FALSE)
  periodogram <- as.data.frame(periodogram[periodogram[,1] <= 20,])
  periodogram$stage <- y
  periodogram
}, SIMPLIFY = F)

df <- do.call("rbind", periodograms) %>%
    group_by(hz,stage) %>%
    summarize(dB = mean(dB)) %>%
    ungroup()

ggplot(df, aes(x=hz,y=dB,color=stage)) +
  geom_line() + theme_bw() +
  theme(legend.title = element_blank()) + 
  scale_colour_manual(name = "stage",
                      values = c("#F98400","#F2AD00","#00A08A","#FF0000","#5BBCD6")) +
  xlab("Hertz") + ylab("PSD")

```

## Machine learning

## References

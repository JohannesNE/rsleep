---
title: "Spectral analysis of electroencephalography (EEG) signals in sleep data"
output: rmarkdown::html_vignette
bibliography: Spectral_analysis_of_EEG_signals.bibtex
csl: vignettes.csl
vignette: >
  %\VignetteIndexEntry{Spectral_analysis_of_EEG_signals}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

knitr::opts_chunk$set(eval = all(file.exists("15012016HD.edf","15012016HD.csv")))
```

Electroencephalography (EEG) refers to all the methods of recording, analysis and interpretation of the electrical activity of the brain. In clinical EEG, multiple electrodes are usually placed on the scalp, measuring its superficial activity over time. Electrodes are typically arranged using the standardized 10-20 system @niedermeyerElectroencephalographyBasicPrinciples2005, allowing reproductibility of the results between recordings. 

EEG is a major component in sleep analysis. Sleep stages, such as slow wave sleep or paradoxical sleep are mainly defined over visual EEG characteristics @AASMScoringManual. Many sleep related disorders can be identified in EEG data. Polysomnography, the gold standard exam in sleep medicine, includes EEG along many other physiological recordings  @ibanezSurveySleepAssessment2018. 

Raw EEG data can be found in sleep records files. In European Data Format (EDF) @Kemp1992 records, EEG channels can be found labelled under their placement names. This vignette provides a basic introduction to spectral analysis of EEG signal from sleep records files.

## Sleep data

An example EDF file and its scoring can be donwloaded using the following code:

```{r download_data, eval=FALSE}
download.file("https://osf.io/57j2u/download", "15012016HD.edf")
download.file("https://osf.io/h4ysj/download", "15012016HD.csv")
```

The `.edf` file contains signals and metadata. The `.csv` file contains the scoring, exported from Noxturnal, a visual analysis software for sleep data published by Resmed.

This night has been recorded on healthy subject at the Sleep and Vigilance center of the HÃ´tel-Dieu, Paris, France. The R package [`edfReader`](https://cran.r-project.org/web/packages/edfReader/index.html) reads `.edf` files. Reading an `.edf` file takes two steps: First reading the headers of the file, then reading the selected signals. The following spectral analysis will only be performed on a single channel of the EEG, `C3-M2`.

```{r read_edf}
library(edfReader)

h <- readEdfHeader("15012016HD.edf")

s <- readEdfSignals(h, signals = "C3-M2")
```

Visual scoring of this record can be plotted in the following hypnogram using the rsleep package:

```{r hypnogram, fig.width = 7}
library(rsleep)

events <- read_events_noxturnal("15012016HD.csv")

plot_hypnogram(events)
```

The hypnogram show sleep stages over time using consecutive 30 seconds epochs. A sleep expert scored this record visually following the guidelines from the American Association of Sleep Medicine (AASM) @AASMScoringManual. Five stages can be observed:

  * **AWA**: Awakeness.
  * **REM**: Rapid-Eye-Movement (REM) sleep, or paradoxical sleep.
  * **N1**: Light sleep, a transitional stage.
  * **N2,N3**: Slow-wave sleep.

## Spectrogram

The Fourier transform (FT) may be the most important function in signal analysis. It decomposes the signal into its constituent frequencies. A nice interactive and visual explanation of Fourier transform can be found on [\@jezzamon](https://twitter.com/jezzamonn) website: [http://www.jezzamon.com/fourier/](http://www.jezzamon.com/fourier/).

Applied to EEG, Fourier transform gives an overview of the frequencies making the brain activity. 
A **spectrogram** is the visualisation of these frequencies densities over time. It chops the signal into overlapping slices, windows each slice and applies a Fourier transform to determine the frequency components at that slice. The `spectrogram` function from the `rsleep` package draw a spectrogram from a given signal. The function is a wrapper over the `specgram` function from the `signal` package, adapted to the long signals vectors found in sleep data, defining colors and limiting the frequencies displayed to 25 Hertz. Those parameters can be modified in the function call.

```{r spectrogram, fig.width = 7}
spectrogram(signal = s$signal,
            sRate = s$sRate,
            startTime = as.POSIXct(s$startTime))
```

This heatmap show an estimate of power spectral density (PSD) by frequency over time. Periods of higher PSD in the lower part of the spectrum occurs all along the night. Similar Patterns can be identified between the hypnogram and the spectrogram. Higher PSD in lower frequencies of the EEG is indeed the main characteristic of deep sleep.

## Spectrum bands

The traditional way to simplify the EEG spectrogram is to cut the frequencies of the spectrum into bands or ranges @niedermeyerElectroencephalographyBasicPrinciples2005:

  * **Delta**: Below `3.5` Hertz, the Delta band is associated with slow-wave sleep in adults subjects.
  
  * **Theta**: Between `3.5` and `7.5` Hertz, the Theta band is associated with drowsiness in adults and teens subjects.
  
  * **Alpha**: Between `7.5` and `13` Hertz, the Alpha band is associated with a relaxed state and eyes closed.
  
  * **Beta**: Between `13` and `30` Hertz the Beta band is associated with active thinking, focus, high alert or anxiousness.

  * **Gamma**: Over `30` Hertz the Gamma band is mostly used for animal EEG analysis.

### Epoching

As sleep is usually analyzed over 30 seconds periods, spectral activity can be computed over the same periods to compare it to the sleep stages scoring.

The epochs function from the rsleep package cut the signal according to the hypnogram periods. It returns a list of signal chunks.

```{r epochs}
hypnogram <- hypnogram(events)

epochs <- epochs(signals = s$signal,
                 sRates = s$sRate,
                 epoch = hypnogram,
                 startTime = as.numeric(as.POSIXct(s$startTime)))
```

Bands can be computed using the bands_power of the rsleep package.

```{r}
bands <- lapply(epochs,function(x){
    bands_power(bands = list(c(0.5,3.5),c(3.5,7.5),c(7.5,13),c(13,30)),
                signal = x, sRate = s$sRate,
                normalize = c(0.5,30))
})
```

After some reshaping, bands psd distribution can be plotted per stage

```{r}
library(ggplot2)

bands_df <- data.frame(matrix(unlist(bands), nrow=length(bands), byrow=TRUE))

colnames(bands_df) <- c("Delta","Theta","Alpha","Beta")

bands_df$stage <- hypnogram$event[-1]
bands_df$epoch <- c(1:nrow(bands_df))

bands_df_long <- reshape2::melt(bands_df, c("stage","epoch"))
 
ggplot(bands_df_long,
       aes(x=stage,y=value,color=stage)) +
  geom_boxplot() +
  facet_grid(rows = vars(variable),scales = "free") +
  scale_colour_manual(name = "stage",
                      values = c("#F98400",
                                 "#F2AD00",
                                 "#00A08A",
                                 "#FF0000",
                                 "#5BBCD6")) +
  theme_bw() + xlab("") + ylab("PSD") + 
  theme(legend.position = "none")
```

### Along the night

```{r}
ggplot(bands_df_long,
       aes(x=epoch,y=value,color=variable)) +
  geom_line()
```

## Periodogram

```{r periodogram, fig.width=7, message=FALSE, error=FALSE}
library(dplyr)

psdres <- sm(epochs[[1]], s$sRate, 100)

periodograms <- mapply(x = epochs, y = hypnogram$event[-1], FUN = function(x,y){
  periodogram <- pwelch(x, sRate = s$sRate, show = FALSE)
  periodogram <- as.data.frame(periodogram[periodogram$hz <= 20,])
  periodogram$stage <- y
  periodogram
}, SIMPLIFY = F)

df <- do.call("rbind", periodograms) %>%
    group_by(hz,stage) %>%
    summarize(psd = mean(psd)) %>%
    ungroup()

ggplot(df, aes(x=hz,y=psd,color=stage)) +
  geom_line() + theme_bw() +
  theme(legend.title = element_blank()) + 
  scale_colour_manual(name = "stage",
                      values = c("#F98400","#F2AD00","#00A08A","#FF0000","#5BBCD6")) +
  xlab("Hertz") + ylab("PSD")

```

## Machine learning

Would it be possible to classify sleep stage using periodogram of a single channel eeg?

```{r}

set.seed(12345)

library(caret)

pw <- mapply(x = epochs, y = hypnogram$event[-1], FUN = function(x,y){
  periodogram <- psm(x, sRate = s$sRate, 200) %>%
    dplyr::filter(hz <= 20) %>%
    reshape2::dcast(formula = psd ~ hz,
                    value.var = "psd")
    
  periodogram$psd <- NULL
  periodogram$`0` <- NULL
  
  sapply(periodogram,function(x){
    max(x,na.rm = TRUE)
    })

}, SIMPLIFY = F)

df <- as.data.frame(do.call("rbind", pw))

df$stage <-  hypnogram$event[-1]

inTrain <- caret::createDataPartition(df$stage, p=0.80, list=F)
training <- df[inTrain, ]
validation <- df[-inTrain, ]

cl <- parallel::makeCluster(parallel::detectCores())
doParallel::registerDoParallel(cl)
control <- caret::trainControl(method="cv", 3,allowParallel = TRUE)
fit <- caret::train(stage ~ .,
                    data= df,
                    method= 'rf')
parallel::stopCluster(cl)

results <- predict(fit, newdata = validation)
fit

```

sm
mtry  Accuracy   Kappa    
   2    0.8836683  0.8358472
  21    0.8748001  0.8233672
  40    0.8699981  0.8166512

  
## References

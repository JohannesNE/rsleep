---
title: "Sleep Stages Classification Using Deep Learning"
author: "Paul Bouchequet"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{automatic-stage-classification}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Do not run chunks if files are not present.
knitr::opts_chunk$set(
  eval = all(file.exists(
    "15012016HD.edf","15012016HD.csv",
    "SC4001E0-PSG.edf", "SC4002E0-PSG.edf",
    "SC4001EC-Hypnogram.edf", "SC4002EC-Hypnogram.edf")))

```

# Introduction

`rsleep` provides function to score sleep stages from polysomnography data using
deep neural networks. A pre-trained model can be downloaded and applied. As
this model have been trained using polysomnography data from a single recorder
(Nox A1, Resmed), a new model can be trained on new data after generating a 
training database.

# Example data

First, download an example polysomnography record:

```{r download_edf, eval=FALSE}
download.file("https://osf.io/57j2u/download", "15012016HD.edf")
```

This polysomnography have been recorded at the Center for Sleep and Vigilance of
the Hôtel-Dieu, Paris, France, on a healthy subject. Only physiological signals 
are contained in this file. The corresponding hypnogram can be downloaded using 
using the following line:

```{r  download_hypnogram, eval=FALSE}
download.file("https://osf.io/h4ysj/download", "15012016HD.csv")
```

The hypnogram show sleep stages over time using consecutive 30 seconds epochs. 
Sleep experts usually score sleep records visually following the guidelines from
the American Association of Sleep Medicine (AASM) @AASMScoringManual. 
Five stages can be observed:

  * **AWA**: Awakeness.
  * **REM**: Rapid-Eye-Movement, REM (paradoxical) sleep, highlighted in red.
  * **N1**: Light sleep transitional stage.
  * **N2**: Light sleep.
  * **N3**: Slow-wave sleep.
  
This polysomnography has been visually scored by a sleep expert. Results of this
scoring can be found in the downloaded `.csv` file. This file has been exported 
from Noxturnal, a visual sleep scoring software published by Resmed. The 
`read_events_noxturnal()` function from the `rsleep` package can read this export
and clean it to produce a standardized events dataframe. Then, the 
`plot_hypnogram()` function plots the hypnogram related events into a stage/time
figure.

```{r, fig.width=7}
library(rsleep)

events <- read_events_noxturnal("15012016HD.csv")

plot_hypnogram(events)
```

# Applying a pre-trained model

Visual sleep scoring is an emprical science requiring a considerable amount of 
clinical knowledge @tongQuantitativeEEGAnalysis2009. However, many publications
showed scoring can be achieved by machine learning algorithms. In this field, 
deep neural networks showed the best results, similar to human sleep expert.

The `rsleep` package provides a pretrained model to score stages from raw sleep
signals. This model have been firstly trained on more than a hundred sleep 
records from the Hôtel-Dieu using the deep neural network described by Stanislas
Chamban & Al. in "A Deep Learning Architecture for Temporal Sleep Stage 
Classification Using Multivariate and Multimodal Time Series". 
@chambonDeepLearningArchitecture2017

To use this pre-trained model, call the `score_stages_edf()` function to score 
stages from the previously downloaded EDF file. `score_stages_edf()` returns
hypnodensity results, the probability of each sleep stage by epoch. Hypnodensity
has been introduced by Stephansen & Al. in 2018 in "".

```{r}
hypnodensity <- score_stages_edf("15012016HD.edf")
```

Plot the hypnodensity.

```{r, fig.width=7}
plot_hypnodensity(hypnodensity)
```

Hypnogram can be computed form the hypnodensity taking the highest probability

```{r, fig.width=7}
plot_hypnogram(hypnodensity)
```

Plot the visually scored hypnogram as a comparison.

# Training a new model

Unfortunately, 

```{r}
library(DiagrammeR)

create_graph() %>%
  add_node(label = "generate_batches()") %>%
  add_node(label = "train_batches()") %>%
  add_node(label = "score_stages_edf()") %>%
  add_edge(from = 1, to = 2) %>%
  add_edge(from = 2, to = 3) %>%
  render_graph(layout = "tree")
```


## Generating a training database

```{r}
records <- c("SC4001E0-PSG.edf", "SC4002E0-PSG.edf")

hypnograms <- c("SC4001EC-Hypnogram.edf", "SC4002EC-Hypnogram.edf")

for(file in c(records,hypnograms)){
  if(!file.exists(file)){
    download.file(url = paste0(
      "https://physionet.org/files/sleep-edfx/1.0.0/sleep-cassette/",
      file, "?download"
    ), destfile = file)
  }
}
```


```{r}
hypnogram <- read_events_sleepedfx("SC4001EC-Hypnogram.edf")[-1,]

generate_batches(
  records = c("SC4001E0-PSG.edf"),
  events = list(hypnogram),
  batches_path = "./", batches_size = 128,
  channels = c("EEG Fpz-Cz","EEG Pz-Oz",
               "EOG horizontal","EMG submental",
               "Temp rectal"))
```

## Defining the model architecture

```{r}
model <- model_stagesdl(batch = "./batch_1.rds")

summary(model)
```

## Training the model

```{r}
batches <- list.files(pattern = "batch*")

model <- train_batches(
  model = model_stagesdl(batches[1]),
  batches = batches)
```


## Applying the model

```{r}
saveRDS(object = keras::serialize_model(model),
        file = "model_stagesdl.rds")

hypnodensity <- score_stages_edf(
  edf = "SC4002E0-PSG.edf",
  model_path = "model_stagesdl.rds",
  channels = c("EEG Fpz-Cz","EEG Pz-Oz",
               "EOG horizontal","EMG submental",
               "Temp rectal"))

plot_hypnodensity(hypnodensity)

plot_hypnogram(read_events_sleepedfx("SC4002EC-Hypnogram.edf")[-1,])
```

```{r}
file.remove(list.files(pattern = "*batch*"))
```





